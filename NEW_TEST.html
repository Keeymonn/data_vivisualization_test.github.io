<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Тест для тестирования по курсу визуализация данных</title>
  <style>
    html, body {
      height: 100%;
      margin: 0; padding: 0;
      overflow: hidden;
    }
    body.scroll-enabled {
      overflow: auto;
    }
    body {
      min-height: 100vh;
      width: 100vw;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Montserrat', Arial, sans-serif;
      color: #222;
      overflow-x: hidden; /* Запрещаем горизонтальную прокрутку */
      position: relative;
    }

    .container {
      min-height: 100vh;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 12px 60px;
      box-sizing: border-box;
    }
    .form-box {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 0 24px 0 #b4a6e7;
      padding: 32px 28px 28px 28px;
      min-width: 420px;
      max-width: 96vw;
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-bottom: 38px;
      box-sizing: border-box;
    }
    .form-box label {
      font-size: 1.18rem;
      font-weight: 500;
      color: #2d234f;
      margin-bottom: 4px;
      margin-top: 6px;
      letter-spacing: 0.01em;
    }
    .form-box input[type="number"],
    .form-box select {
      width: 100%;
      padding: 12px 12px;
      font-size: 1.08rem;
      border: 1.5px solid #e2dffb;
      border-radius: 8px;
      background: #faf9ff;
      outline: none;
      transition: border-color 0.2s;
      box-sizing: border-box;
      margin-bottom: 0;
      color: #2d234f;
      font-family: inherit;
      cursor: pointer;
    }
    .form-box input[type="number"]:focus,
    .form-box select:focus {
      border-color: #a08ee6;
    }
    .form-box button {
      margin-top: 10px;
      padding: 12px 0;
      width: 100%;
      background: #8f7ae7;
      color: #fff;
      font-size: 1.13rem;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px #b4a6e7;
      cursor: pointer;
      transition: background 0.2s;
      letter-spacing: 0.01em;
      box-sizing: border-box;
    }
    .form-box button:hover {
      background: #7c6ee6;
    }
    #loading {
      text-align: center;
      font-size: 28px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 24px;
      margin-top: 16px;
      min-height: 32px;
      letter-spacing: 1px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #quizContainer {
      width: 100%;
      max-width: 1070px;
      margin: 0 auto 24px auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
      box-sizing: border-box;
    }
    .question-block {
      background: white;
      border-radius: 16px;
      padding: 20px 18px 18px 18px;
      margin-bottom: 0;
      box-shadow: 0 0 24px 0 #b4a6e7;
      border: 2px solid transparent;
      transition: border-color .4s;
      width: 100%;
      max-width: 1070px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow: hidden;
    }
    .question-block.required {
      border-color: #ff4f4f;
      animation: shake 0.4s;
    }
    @font-face {
      font-family: 'MyCustomFont';
      src: url('../сайт/OffBit-Bold.ttf') format('truetype');
    }
    .question-text {
      font-weight: 700;
      font-size: 1.04rem;
      margin-bottom: 14px;
      flex-shrink: 0;
      box-sizing: border-box;
    }
    .options {
      overflow-y: auto;
      flex-grow: 1;
      box-sizing: border-box;
    }
    .options label {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1rem;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: 10px;
      border: 1.5px solid transparent;
      background: transparent;
      margin-bottom: 10px;
      transition: background-color 0.3s, border-color 0.3s;
      user-select: none;
      box-sizing: border-box;
    }
    .options label:hover:not(.correct):not(.incorrect) {
      background-color: transparent;
    }
    .options input[type="radio"],
    .options input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #7c6ee6;
      cursor: pointer;
      box-sizing: border-box;
    }
    .correct {
      background-color: #d4edda !important;
      border-color: #28a745 !important;
      color: #155724;
    }
    .incorrect {
      background-color: #f8d7da !important;
      border-color: #dc3545 !important;
      color: #721c24;
    }
    #checkBtn {
      background-color: #FF9C12;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 1.13rem;
      padding: 12px 0;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      max-width: 320px;
      margin: 32px auto 60px auto;
      display: none;
      transition: background 0.2s;
      box-shadow: 0 2px 10px #FF9C12;
      box-sizing: border-box;
    }
    #checkBtn:hover {
      background-color: #FF9C12;
    }
    @media (max-width: 1100px) {
      #quizContainer, .question-block {
        width: 95vw !important;
        max-width: none !important;
      }
    }
    @media (max-width: 500px) {
      .container { max-width: 99vw; }
      .form-box, #quizContainer { max-width: 99vw; }
      .form-box { padding: 12px 4vw 18px 4vw; }
      .question-block { padding: 12px 3vw 10px 3vw; height: auto; }
    }
 
  </style>
</head>
<body class="scroll-enabled">
  <div class="container">
    <h1 style="text-align: center; margin-bottom: 40px; color: #2d234f;">
      <span style="font-family: 'MyCustomFont'; src: url(../сайт/OffBit-Bold.ttf); font-size: 55px;">Создай тест и проверь себя сам по визуализации данных!</span>
    </h1>
    <div class="form-box" aria-label="Настройки теста">
      <label for="questionCount">Количество вопросов (1-10)</label>
      <input type="number" id="questionCount" min="1" max="10" value="1" />

      <label for="answerType">Типы ответов</label>
      <select id="answerType">
        <option value="single">Одиночный</option>
        <option value="multiple">Множественный</option>
        <option value="combined">Комбинированный</option>
      </select>

      <label for="difficulty">Сложность вопросов</label>
      <select id="difficulty">
        <option value="easy">Легкие</option>
        <option value="medium" selected>Средние</option>
        <option value="hard">Сложные</option>
      </select>

      <button id="createTestBtn">Создать тест</button>
    </div>

    <div id="loading" style="display:none"><span style="font-family: 'MyCustomFont'; src: url(../сайт/OffBit-Bold.ttf); font-size: 40px;">Генерируем...</span></div>

    <form id="quizContainer" aria-live="polite" aria-atomic="true"></form>

    <button id="checkBtn" type="button">Проверить</button>
  </div>
  <script>
    const createTestBtn = document.getElementById('createTestBtn');
    const checkBtn = document.getElementById('checkBtn');
    const quizContainer = document.getElementById('quizContainer');
    const loading = document.getElementById('loading');

    async function fetchQuestions(count, answerType, difficulty) {
      const prompt = `
Ты — эксперт по визуализации данных, который оценивает пользователей (статистика, анализ данных, дизайн, программирование визуализации). 
Необходимо создать тест для проверки знаний по курсу "Визуализация данных", он должен содержать разностроннии вопросы, которые будут охватывать весь объем знаний по курсу, 
используй литератуту по предмету и методические пособия. Важно охватывать разные темы в одном тесте: 
Основные типы диаграмм и графиков (гистограммы, линейные графики, круговые диаграммы, тепловые карты и др.)
Принципы выбора визуализации для разных типов данных,
Интерпретация и анализ визуальных представлений данных,
Цветовые схемы и восприятие цвета,
Ошибки и искажения в визуализации данных,
Инструменты и библиотеки для визуализации,
Основы статистики, важные для визуализации (распределения, корреляции).
Сгенерируй ${count} вопрос${count > 1 ? 'ов' : ''} для теста по визуализации данных.
Каждый вопрос должен иметь 3-4 варианта ответа.
Тип ответа: ${answerType === 'single' ? 'одиночный выбор' : answerType === 'multiple' ? 'множественный выбор' : 'комбинированный (часть вопросов с одиночным, часть с множественным выбором)'}.
Сложность вопросов: ${difficulty}.
Вопросы не должны содержать изображений.
Формат ответа JSON-массив с объектами:
[
  {
    "question": "текст вопроса",
    "type": "single" или "multiple",
    "options": ["вариант 1", "вариант 2", "вариант 3", "вариант 4"],
    "correct": [индексы правильных вариантов, например [0] или [1,3]]
  },
  ...
]
Ответь только JSON без дополнительного текста.
      `;

      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer 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',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'qwen/qwen3-235b-a22b:free',
          messages: [{ role: 'user', content: prompt }],
        }),
      });

      if (!response.ok) {
        throw new Error(`Ошибка сети: ${response.statusText}`);
      }

      const data = await response.json();
      const content = data.choices?.[0]?.message?.content;
      if (!content) throw new Error('Ответ нейросети пустой');

      try {
        const jsonStart = content.indexOf('[');
        const jsonEnd = content.lastIndexOf(']');
        const jsonString = content.substring(jsonStart, jsonEnd + 1);
        return JSON.parse(jsonString);
      } catch (e) {
        throw new Error('Не удалось распарсить JSON от нейросети: ' + e.message);
      }
    }

    function renderTest(questions, globalAnswerType) {
      quizContainer.innerHTML = '';
      questions.forEach((q, i) => {
        const block = document.createElement('section');
        block.className = 'question-block';
        block.id = `question-${i}`;
        block.setAttribute('tabindex', '-1');

        const qNumber = document.createElement('h3');
        qNumber.className = 'question-text';
        qNumber.textContent = `Вопрос ${i + 1}: ${q.question}`;
        block.appendChild(qNumber);

        let type = globalAnswerType === 'combined' ? q.type : globalAnswerType;
        if (type !== 'single' && type !== 'multiple') type = 'single';

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';

        q.options.forEach((opt, idx) => {
          const optionId = `q${i}_opt${idx}`;
          const label = document.createElement('label');
          label.htmlFor = optionId;

          const input = document.createElement('input');
          input.type = type === 'single' ? 'radio' : 'checkbox';
          input.name = `q${i}`;
          input.id = optionId;
          input.value = idx;

          label.appendChild(input);
          label.appendChild(document.createTextNode(opt));

          optionsDiv.appendChild(label);
        });

        block.appendChild(optionsDiv);
        quizContainer.appendChild(block);
      });
    }

    function checkAnswers(questions, globalAnswerType) {
  let firstUnanswered = null;

  questions.forEach((q, i) => {
    const block = document.getElementById(`question-${i}`);
    block.classList.remove('required');

    const inputs = quizContainer.querySelectorAll(`[name="q${i}"]`);
    const selectedIndexes = [];
    inputs.forEach(input => {
      if (input.checked) selectedIndexes.push(Number(input.value));
    });

    if (selectedIndexes.length === 0 && !firstUnanswered) {
      firstUnanswered = block;
      block.classList.add('required');
    }
  });

  if (firstUnanswered) {
    firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return false; // Есть неотвеченные вопросы
  }

  questions.forEach((q, i) => {
    const type = globalAnswerType === 'combined' ? q.type : globalAnswerType;
    const inputs = quizContainer.querySelectorAll(`[name="q${i}"]`);

    inputs.forEach(input => {
      input.disabled = true; // Запрет менять ответы после проверки
    });

    inputs.forEach(input => {
      const label = input.parentElement;
      const idx = Number(input.value);
      label.classList.remove('correct', 'incorrect');

      if (q.correct.includes(idx)) {
        label.classList.add('correct'); // Подсветка правильных вариантов
      }

      if (!q.correct.includes(idx) && input.checked) {
        label.classList.add('incorrect'); // Подсветить неверно выбранные варианты
      }
    });
  });

  return true;
}


    createTestBtn.addEventListener('click', async () => {
      checkBtn.style.display = 'none';
      checkBtn.disabled = false;
      quizContainer.innerHTML = '';
      loading.style.display = 'flex';

      const count = parseInt(document.getElementById('questionCount').value, 10);
      const answerType = document.getElementById('answerType').value;
      const difficulty = document.getElementById('difficulty').value;

      if (isNaN(count) || count < 1 || count > 10) {
        alert('Введите количество вопросов от 1 до 10');
        loading.style.display = 'none';
        return;
      }

      try {
        const questions = await fetchQuestions(count, answerType, difficulty);
        loading.style.display = 'none';

        if (!Array.isArray(questions) || questions.length === 0) {
          alert('Не удалось получить вопросы от нейросети.');
          return;
        }

        renderTest(questions, answerType);
        checkBtn.style.display = 'block';

        // Разрешаем прокрутку страницы после генерации теста
        document.body.classList.add('scroll-enabled');

        const firstQuestion = document.querySelector('.question-block');
        if (firstQuestion) {
          firstQuestion.focus();
          firstQuestion.scrollIntoView({ behavior: 'smooth' });
        }

        window.currentTest = { questions, answerType };
      } catch (e) {
        loading.style.display = 'none';
        alert('Ошибка при генерации теста: ' + e.message);
      }
    });

    checkBtn.addEventListener('click', () => {
      if (!window.currentTest) return;

      const { questions, answerType } = window.currentTest;
      const allAnswered = checkAnswers(questions, answerType);

      if (allAnswered) {
        checkBtn.disabled = true;
      }
    });
  </script>
</body>
</html>
